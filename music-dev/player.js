const audioPlayer=document.getElementById("audioPlayer"),playBtn=document.getElementById("playBtn"),prevBtn=document.getElementById("prevBtn"),nextBtn=document.getElementById("nextBtn"),loopBtn=document.getElementById("loopBtn"),orderBtn=document.getElementById("orderBtn"),volumeSlider=document.getElementById("volumeSlider"),progressSlider=document.getElementById("progressSlider"),currentTime=document.getElementById("currentTime"),durationTime=document.getElementById("durationTime"),albumCover=document.getElementById("albumCover"),trackTitle=document.getElementById("trackTitle"),trackArtist=document.getElementById("trackArtist"),lyricsDisplay=document.getElementById("lyricsDisplay"),lyricsPlaceholder=document.getElementById("lyricsPlaceholder"),easyModeBtn=document.getElementById("easyModeBtn"),fullModeBtn=document.getElementById("fullModeBtn"),easyModeContainer=document.getElementById("easyModeContainer"),fullModeContainer=document.getElementById("fullModeContainer"),apiBase=document.getElementById("apiBase"),apiServer=document.getElementById("apiServer"),apiType=document.getElementById("apiType"),apiId=document.getElementById("apiId"),fullApiInput=document.getElementById("fullApiInput"),loadApiBtn=document.getElementById("loadApiBtn"),clearPlaylistBtn=document.getElementById("clearPlaylistBtn"),playlistDisplay=document.getElementById("playlistDisplay"),recommendContainer=document.getElementById("recommendContainer");class controlTabs{constructor(e){this.element=e,this.navItems=this.element.querySelectorAll(".controlTab-nav li"),this.panels=this.element.querySelectorAll(".controlTab-panel"),this.init()}init(){this.navItems.forEach(e=>{e.addEventListener("click",e=>this.switchControlTab(e))})}switchControlTab(e){const t=e.currentTarget.getAttribute("data-controlTab");this.navItems.forEach(e=>e.classList.remove("active")),this.panels.forEach(e=>e.classList.remove("active")),e.currentTarget.classList.add("active"),document.getElementById(t).classList.add("active")}}function toggleContainer(e,t){e.classList.contains("active")?closeContainer(e,t):(document.querySelectorAll(".slide-container.active").forEach(a=>{a!==e&&closeContainer(a,t)}),e.classList.add("active"),t.classList.add("active"),document.body.style.overflow="hidden")}function closeContainer(e,t){e.classList.remove("active"),0===document.querySelectorAll(".slide-container.active").length&&(t.classList.remove("active"),document.body.style.overflow="")}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".mycontrolTabs").forEach(e=>{new controlTabs(e)})}),document.addEventListener("DOMContentLoaded",function(){let e=document.querySelector(".slide-container-mask");e||(e=document.createElement("div"),e.className="slide-container-mask",document.body.appendChild(e)),document.querySelectorAll(".slide-toggle").forEach(t=>{t.addEventListener("click",function(){const t=this.getAttribute("data-target"),a=document.getElementById(t);a&&toggleContainer(a,e)})}),document.querySelectorAll(".slide-container .close-btn").forEach(t=>{t.addEventListener("click",function(t){t.stopPropagation(),closeContainer(this.closest(".slide-container"),e)})}),e.addEventListener("click",function(){document.querySelectorAll(".slide-container.active").forEach(t=>{closeContainer(t,e)})}),document.querySelectorAll(".slide-container").forEach(e=>{e.addEventListener("click",function(e){e.stopPropagation()})})}),void 0===window.PlayerConfig&&(console.warn("未检测到 config.js，使用默认音量配置"),window.PlayerConfig={volumeKey:"desktop_player_volume",defaultVolume:.5,_internalLastVolKey:"__lastVolKey",apiBaseTemplate:["https://api.i-meto.com/meting/api?server=:server&type=:type&id=:id&r=:r","https://apivc-meting.sakurink.eu.org/api?server=:server&type=:type&id=:id&r=:r"],defaultApiBaseIndex:1,fullApiExample:"https://apivc-meting.sakurink.eu.org/api?server=netease&type=playlist&id=8510095321&r=:r",defaultApiId:"8510095321",defaultApiServers:[{value:"netease",label:"网易云"},{value:"tencent",label:"QQ音乐"},{value:"kugou",label:"酷狗"},{value:"kuwo",label:"酷我"}],defaultApiTypes:[{value:"playlist",label:"歌单"},{value:"song",label:"单曲"},{value:"search",label:"搜索"}],recommendConfig:null,recommendItems:[]});const LOOP_MODE_KEY=PlayerConfig.loopModeKey,DEFAULT_LOOP_MODE=PlayerConfig.defaultLoopMode,PLAY_ORDER_KEY=PlayerConfig.playOrderKey,DEFAULT_PLAY_ORDER=PlayerConfig.defaultPlayOrder,lastLoopModeKey=localStorage.getItem("__lastLoopModeKey"),lastPlayOrderKey=localStorage.getItem("__lastPlayOrderKey");lastLoopModeKey&&lastLoopModeKey!==LOOP_MODE_KEY&&(console.log(`[循环模式] 检测到 LOOP_MODE_KEY 已变更："${lastLoopModeKey}" → "${LOOP_MODE_KEY}"，正在清理旧键...`),localStorage.removeItem(lastLoopModeKey)),lastPlayOrderKey&&lastPlayOrderKey!==PLAY_ORDER_KEY&&(console.log(`[播放顺序] 检测到 PLAY_ORDER_KEY 已变更："${lastPlayOrderKey}" → "${PLAY_ORDER_KEY}"，正在清理旧键...`),localStorage.removeItem(lastPlayOrderKey)),localStorage.setItem("__lastLoopModeKey",LOOP_MODE_KEY),localStorage.setItem("__lastPlayOrderKey",PLAY_ORDER_KEY);const savedLoopMode=localStorage.getItem(LOOP_MODE_KEY),finalLoopMode=savedLoopMode&&["loop","single","none"].includes(savedLoopMode)?savedLoopMode:DEFAULT_LOOP_MODE,savedPlayOrder=localStorage.getItem(PLAY_ORDER_KEY),finalPlayOrder=savedPlayOrder&&["sequential","random"].includes(savedPlayOrder)?savedPlayOrder:DEFAULT_PLAY_ORDER;PlayerConfig._internalLastVolKey="__lastVolKey";const VOL_KEY=PlayerConfig.volumeKey,DEFAULT_VOLUME=PlayerConfig.defaultVolume,INTERNAL_LAST_VOL_KEY=PlayerConfig._internalLastVolKey,lastVolKey=localStorage.getItem(INTERNAL_LAST_VOL_KEY);lastVolKey&&lastVolKey!==VOL_KEY&&(console.log(`[音量系统] 检测到 VOL_KEY 已变更："${lastVolKey}" → "${VOL_KEY}"，正在清理旧键...`),localStorage.removeItem(lastVolKey),showNotice("音量设置已重置，请重新调整")),localStorage.setItem(INTERNAL_LAST_VOL_KEY,VOL_KEY);const savedVolume=parseFloat(localStorage.getItem(VOL_KEY)),finalVolume=null===savedVolume||isNaN(savedVolume)?DEFAULT_VOLUME:savedVolume;volumeSlider.value=finalVolume,audioPlayer.volume=finalVolume,updateVolumePercent(100*finalVolume);const state={tracks:[],currentIndex:0,isPlaying:!1,isDragging:!1,currentLyrics:[],isLoading:!1,isBusy:!1,loopMode:finalLoopMode,playOrder:finalPlayOrder};function updateLoopIcon(){const e=["loop","single","none"].indexOf(state.loopMode);loopBtn.innerHTML=['<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-repeat" viewBox="0 0 16 16"><path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 0-.384l2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z"/></svg>','<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-repeat-1" viewBox="0 0 16 16"><path d="M11 4v1.466a.25.25 0 0 0 .41.192l2.36-1.966a.25.25 0 0 0 0-.384l-2.36-1.966a.25.25 0 0 0-.41.192V3H5a5 5 0 0 0-4.48 7.223.5.5 0 0 0 .896-.446A4 4 0 0 1 5 4zm4.48 1.777a.5.5 0 0 0-.896.446A4 4 0 0 1 11 12H5.001v-1.466a.25.25 0 0 0-.41-.192l-2.36 1.966a.25.25 0 0 0 0 .384l2.36 1.966a.25.25 0 0 0 .41-.192V13h6a5 5 0 0 0 4.48-7.223Z"/><path d="M9 5.5a.5.5 0 0 0-.854-.354l-1.75 1.75a.5.5 0 1 0 .708.708L8 6.707V10.5a.5.5 0 0 0 1 0z"/></svg>','<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-slash-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="M11.354 4.646a.5.5 0 0 0-.708 0l-6 6a.5.5 0 0 0 .708.708l6-6a.5.5 0 0 0 0-.708"/></svg>'][e]}function updateOrderIcon(){const e=["sequential","random"].indexOf(state.playOrder);orderBtn.innerHTML=['<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8"/></svg>','<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shuffle" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.827 1.24 4.874 2.418.49.552.865 1.102 1.126 1.532.26-.43.636-.98 1.126-1.532C9.173 4.24 10.798 3 13 3v1c-1.798 0-3.173 1.01-4.126 2.082A9.6 9.6 0 0 0 7.556 8a9.6 9.6 0 0 0 1.317 1.918C9.828 10.99 11.204 12 13 12v1c-2.202 0-3.827-1.24-4.874-2.418A10.6 10.6 0 0 1 7 9.05c-.26.43-.636.98-1.126 1.532C4.827 11.76 3.202 13 1 13H.5a.5.5 0 0 1 0-1H1c1.798 0 3.173-1.01 4.126-2.082A9.6 9.6 0 0 0 6.444 8a9.6 9.6 0 0 0-1.317-1.918C4.172 5.01 2.796 4 1 4H.5a.5.5 0 0 1-.5-.5"/><path d="M13 5.466V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m0 9v-3.932a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192"/></svg>'][e]}if("undefined"!=typeof PlayerConfig&&(apiBase&&Array.isArray(PlayerConfig.apiBaseTemplate)&&(apiBase.innerHTML="",PlayerConfig.apiBaseTemplate.forEach((e,t)=>{const a=document.createElement("option");a.value=e.value;const l=e.label;a.textContent=l,apiBase.appendChild(a)}),apiBase.value=PlayerConfig.apiBaseTemplate[0].value),fullApiInput&&(fullApiInput.placeholder=PlayerConfig.fullApiExample||""),fullApiInput&&PlayerConfig.fullApiDefaultValue&&(fullApiInput.value=PlayerConfig.fullApiDefaultValue),apiServer&&Array.isArray(PlayerConfig.defaultApiServers)&&(apiServer.innerHTML="",PlayerConfig.defaultApiServers.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,apiServer.appendChild(t)}),apiServer.value=PlayerConfig.defaultApiServers[0].value),apiType&&Array.isArray(PlayerConfig.defaultApiTypes)&&(apiType.innerHTML="",PlayerConfig.defaultApiTypes.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,apiType.appendChild(t)}),apiType.value=PlayerConfig.defaultApiTypes[0].value),apiId&&(apiId.value=PlayerConfig.defaultApiId||""),easyModeBtn&&fullModeBtn&&(easyModeBtn.classList.add("active"),fullModeBtn.classList.remove("active"),easyModeContainer.style.display="flex",fullModeContainer.style.display="none")),updateLoopIcon(),updateOrderIcon(),easyModeBtn.addEventListener("click",()=>{easyModeBtn.classList.add("active"),fullModeBtn.classList.remove("active"),easyModeContainer.style.display="flex",fullModeContainer.style.display="none"}),fullModeBtn.addEventListener("click",()=>{fullModeBtn.classList.add("active"),easyModeBtn.classList.remove("active"),fullModeContainer.style.display="flex",easyModeContainer.style.display="none"}),volumeSlider.addEventListener("input",e=>{audioPlayer.volume=parseFloat(e.target.value),localStorage.setItem(VOL_KEY,audioPlayer.volume)}),playBtn.addEventListener("click",async()=>{if(0!==state.tracks.length){if(!state.isBusy)try{audioPlayer.paused?(await audioPlayer.play(),state.isPlaying=!0,playBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pause" viewBox="0 0 16 16"><path d="M6 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5m4 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5"/></svg>'):(audioPlayer.pause(),state.isPlaying=!1,playBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393"/></svg>')}catch(e){console.warn("播放/暂停出错：",e),showNotice("播放失败，请尝试下一首")}}else showNotice("请先加载歌单")}),prevBtn.addEventListener("click",()=>playPrevious()),nextBtn.addEventListener("click",()=>playNext()),loopBtn.addEventListener("click",()=>{const e=["loop","single","none"],t=e.indexOf(state.loopMode);state.loopMode=e[(t+1)%e.length],loopBtn.innerHTML=['<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-repeat" viewBox="0 0 16 16"><path d="M11 5.466V4H5a4 4 0 0 0-3.584 5.777.5.5 0 1 1-.896.446A5 5 0 0 1 5 3h6V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m3.81.086a.5.5 0 0 1 .67.225A5 5 0 0 1 11 13H5v1.466a.25.25 0 0 1-.41.192l-2.36-1.966a.25.25 0 0 1 0-.384l2.36-1.966a.25.25 0 0 1 .41.192V12h6a4 4 0 0 0 3.585-5.777.5.5 0 0 1 .225-.67Z"/></svg>','<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-repeat-1" viewBox="0 0 16 16"><path d="M11 4v1.466a.25.25 0 0 0 .41.192l2.36-1.966a.25.25 0 0 0 0-.384l-2.36-1.966a.25.25 0 0 0-.41.192V3H5a5 5 0 0 0-4.48 7.223.5.5 0 0 0 .896-.446A4 4 0 0 1 5 4zm4.48 1.777a.5.5 0 0 0-.896.446A4 4 0 0 1 11 12H5.001v-1.466a.25.25 0 0 0-.41-.192l-2.36 1.966a.25.25 0 0 0 0 .384l2.36 1.966a.25.25 0 0 0 .41-.192V13h6a5 5 0 0 0 4.48-7.223Z"/><path d="M9 5.5a.5.5 0 0 0-.854-.354l-1.75 1.75a.5.5 0 1 0 .708.708L8 6.707V10.5a.5.5 0 0 0 1 0z"/></svg>','<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-slash-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="M11.354 4.646a.5.5 0 0 0-.708 0l-6 6a.5.5 0 0 0 .708.708l6-6a.5.5 0 0 0 0-.708"/></svg>'][(t+1)%e.length],localStorage.setItem(LOOP_MODE_KEY,state.loopMode)}),orderBtn.addEventListener("click",()=>{const e=["sequential","random"],t=e.indexOf(state.playOrder);state.playOrder=e[(t+1)%e.length],orderBtn.innerHTML=['<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8"/></svg>','<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shuffle" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.827 1.24 4.874 2.418.49.552.865 1.102 1.126 1.532.26-.43.636-.98 1.126-1.532C9.173 4.24 10.798 3 13 3v1c-1.798 0-3.173 1.01-4.126 2.082A9.6 9.6 0 0 0 7.556 8a9.6 9.6 0 0 0 1.317 1.918C9.828 10.99 11.204 12 13 12v1c-2.202 0-3.827-1.24-4.874-2.418A10.6 10.6 0 0 1 7 9.05c-.26.43-.636.98-1.126 1.532C4.827 11.76 3.202 13 1 13H.5a.5.5 0 0 1 0-1H1c1.798 0 3.173-1.01 4.126-2.082A9.6 9.6 0 0 0 6.444 8a9.6 9.6 0 0 0-1.317-1.918C4.172 5.01 2.796 4 1 4H.5a.5.5 0 0 1-.5-.5"/><path d="M13 5.466V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m0 9v-3.932a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192"/></svg>'][(t+1)%e.length],localStorage.setItem(PLAY_ORDER_KEY,state.playOrder)}),progressSlider.addEventListener("input",e=>{state.isDragging=!0;const t=parseFloat(e.target.value)/100,a=isFinite(audioPlayer.duration)?audioPlayer.duration*t:0;currentTime.textContent=formatTime(a),highlightLyricsAtTime(a)}),progressSlider.addEventListener("change",e=>{const t=parseFloat(e.target.value)/100,a=isFinite(audioPlayer.duration)?audioPlayer.duration*t:0;audioPlayer.currentTime=a,state.isDragging=!1}),clearPlaylistBtn.addEventListener("click",()=>{state.tracks=[],state.currentIndex=0,renderPlaylist(),resetPlayerUI(),showNotice("歌单已清空")}),loadApiBtn.addEventListener("click",()=>{const e=buildApiUrl();e&&loadMetingApi(e)}),playlistDisplay.addEventListener("click",e=>{const t=e.target.closest(".playlist-item");if(!t)return;const a=parseInt(t.dataset.index);isNaN(a)||a<0||a>=state.tracks.length||playTrack(a)}),window.PlayerConfig&&Array.isArray(PlayerConfig.recommendItems)&&PlayerConfig.recommendConfig){const e=PlayerConfig.recommendConfig,t=PlayerConfig.recommendItems;function getThumbStyle(t){if(e.custom)for(let a of e.custom){const{field:e,value:l,style:r}=a;if(t.hasOwnProperty(e)){if("*"===l&&t[e])return r;if(t[e]===l)return r}}return e.type&&e.type[t.type]?e.type[t.type]:e.default||{}}function renderRecommendItems(){const e=document.getElementById("recommendContainer");e&&(e.innerHTML=t.map(e=>{const t=getThumbStyle(e).thumbBg||"linear-gradient(90deg, #223a52, #123a6b)";return`\n        <div class="recommend-item" data-meta='${JSON.stringify(e)}' style="background: ${t}">\n          <div class="recommend-thumb">\n            ${e.thumb?`<img src="${e.thumb}" alt="封面" onerror="handleThumbError(this)">`:"暂无图片"}\n          </div>\n          <div class="recommend-meta">\n            <div class="recommend-title">${e.title}</div>\n            <div class="recommend-desc">${e.desc}</div>\n          </div>\n          <div class="recommend-arrow">→</div>\n        </div>\n      `}).join(""))}function handleThumbError(e){const t=e.parentElement;t&&(t.innerHTML="暂无图片",t.classList.add("no-thumb"))}renderRecommendItems();const a=document.getElementById("recommendContainer");a&&a.addEventListener("click",e=>{const t=e.target.closest(".recommend-item");if(t)try{const e=JSON.parse(t.getAttribute("data-meta"));let a;a=e.fullapi&&"string"==typeof e.fullapi&&e.fullapi.trim()?e.fullapi+(e.fullapi.includes("?")?"&":"?")+"r="+Math.random():(e.api||apiBase.value).replace(":server",e.server||"netease").replace(":type",e.type||"playlist").replace(":id",e.id||"").replace(":r",Math.random()),loadMetingApi(a)}catch(e){console.error("解析推荐项失败：",e),showNotice("解析推荐项失败")}})}else console.log("[推荐系统] 未检测到 PlayerConfig.recommendConfig 或 recommendItems，推荐区已跳过。");function buildApiUrl(){if(easyModeBtn.classList.contains("active")){const e=apiBase?apiBase.value.trim():"",t=apiServer?apiServer.value:"netease",a=apiType?apiType.value:"playlist",l=apiId?apiId.value.trim():"";return l?e?e.replace(":server",t).replace(":type",a).replace(":id",encodeURIComponent(l)).replace(":r",Math.random()):(showNotice("API基础链接为空，请检查配置"),null):(showNotice("请填写ID"),null)}return(fullApiInput?fullApiInput.value.trim():"")||(showNotice("请填写完整API链接"),null)}async function loadMetingApi(e){if(state.isLoading)showNotice("正在加载，请稍后");else{state.isLoading=!0,loadApiBtn.disabled=!0,loadApiBtn.textContent="加载中...";try{let t,a;try{t=await fetch(e,{cache:"no-store"})}catch(e){return console.error("网络请求失败：",e),void showNotice("网络错误，请检查API链接")}if(!t.ok)return console.error("API返回错误：",t.status,t.statusText),void showNotice(`API错误：${t.status}`);try{a=await t.json()}catch(e){return console.error("JSON解析失败：",e),void showNotice("API返回的不是有效JSON")}if(!Array.isArray(a)||0===a.length)return state.tracks=[],renderPlaylist(),void showNotice("API返回数据为空");state.tracks=a.map(e=>({title:e.name||e.title||"未知标题",artist:e.artist||e.author||(e.artists?e.artists.map(e=>e.name).join("/"):"未知作者"),album:e.album||"",pic:e.pic||e.cover||e.album&&e.album.pic||"",url:e.url||e.path||e.audio||"",lrc:e.lrc||e.lyric||e.lyrics||"",duration:e.time||e.duration||e.dt||e.playtime||0,parsedLyrics:null})),state.currentIndex=0,renderPlaylist(),await playTrack(0),showNotice("歌单加载成功")}catch(e){console.error("加载API失败：",e),showNotice("加载失败，请重试")}finally{state.isLoading=!1,loadApiBtn.disabled=!1,loadApiBtn.textContent="更新歌单"}}}async function playTrack(e){if(!(state.isBusy||e<0||e>=state.tracks.length)){state.isBusy=!0,state.currentIndex=e;try{renderPlaylist(),await loadTrackData(state.tracks[e]),await startPlayback()}catch(e){return console.warn("播放曲目失败：",e),showNotice("播放失败，自动切换到下一首"),state.isBusy=!1,void playNext()}state.isBusy=!1}}async function loadTrackData(e){if(trackTitle.textContent=e.title||"未知标题",trackArtist.textContent=e.artist||"未知作者",e.pic?(albumCover.style.backgroundImage=`url(${e.pic})`,albumCover.style.backgroundSize="cover",albumCover.style.backgroundPosition="center",albumCover.textContent=""):(albumCover.style.backgroundImage="",albumCover.textContent="暂无图片"),await loadLyrics(e),!e.url)throw new Error("无可用音频URL");try{audioPlayer.removeAttribute("crossorigin")}catch(e){console.warn("移除crossorigin属性失败：",e)}if(audioPlayer.src=e.url,audioPlayer.load(),e.pic){const t=document.getElementById("dynamic-bg");if(t){const a=new Image;a.src=e.pic,a.onload=()=>{t.style.backgroundImage=`url(${e.pic})`,t.classList.add("has-bg"),console.log("沉浸式背景已切换")},a.onerror=()=>{console.warn("背景图片加载失败，将不切换背景:",e.pic)}}}}async function loadLyrics(e){if(lyricsDisplay.innerHTML="",lyricsPlaceholder.textContent="加载歌词...",lyricsPlaceholder.style.display="block",state.currentLyrics=[],e.lrc)try{let t=null;if(isUrl(e.lrc))try{const a=await fetch(e.lrc,{cache:"no-store"});a.ok&&(t=await a.text())}catch(e){console.warn("加载歌词文件失败：",e)}else"string"==typeof e.lrc&&(t=e.lrc);if(t){const a=parseLyrics(t);e.parsedLyrics=a,renderLyrics(a)}else lyricsPlaceholder.textContent="暂无歌词"}catch(e){console.warn("解析歌词失败：",e),lyricsPlaceholder.textContent="歌词加载失败"}else lyricsPlaceholder.textContent="暂无歌词"}async function startPlayback(){try{const e=audioPlayer.play();void 0!==e&&await Promise.race([e,new Promise((e,t)=>setTimeout(()=>t(new Error("播放超时")),8e3))]),playBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pause" viewBox="0 0 16 16"><path d="M6 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5m4 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5"/></svg>',state.isPlaying=!0}catch(e){throw console.warn("播放失败：",e),e}}function playPrevious(){if(0===state.tracks.length)return;if(state.isBusy)return;let e;if("random"===state.playOrder)if(1===state.tracks.length)e=0;else do{e=Math.floor(Math.random()*state.tracks.length)}while(e===state.currentIndex&&state.tracks.length>1);else e=(state.currentIndex-1+state.tracks.length)%state.tracks.length;playTrack(e)}function playNext(){if(0===state.tracks.length)return;if(state.isBusy)return;let e;if("random"===state.playOrder)if(1===state.tracks.length)e=0;else do{e=Math.floor(Math.random()*state.tracks.length)}while(e===state.currentIndex&&state.tracks.length>1);else e=(state.currentIndex+1)%state.tracks.length;playTrack(e)}function handleTrackEnded(){switch(state.loopMode){case"single":audioPlayer.currentTime=0,audioPlayer.play();break;case"loop":playNext();break;case"none":if(playBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393"/></svg>',state.isPlaying=!1,state.currentLyrics.length>0){const e=state.currentLyrics[state.currentLyrics.length-1];e&&null!==e.time&&highlightLyricsAtTime(audioPlayer.duration)}}}function renderPlaylist(){playlistDisplay.innerHTML="",0!==state.tracks.length?state.tracks.forEach((e,t)=>{const a=document.createElement("div");a.className="playlist-item"+(t===state.currentIndex?" active":""),a.dataset.index=t;const l=formatDuration(e.duration);a.innerHTML=`\n      <img class="playlist-thumb" src="${e.pic||""}" onerror="this.style.background='linear-gradient(90deg,#223a52,#123a6b)';this.src='';this.alt='无封面'">\n      <div class="playlist-meta">\n        <div class="playlist-title">${escapeHtml(e.title)}</div>\n        <div class="playlist-artist">${escapeHtml(e.artist)}</div>\n      </div>\n      <div class="playlist-duration">${l}</div>\n    `,playlistDisplay.appendChild(a)}):playlistDisplay.innerHTML='<div class="small-text">暂无歌曲，使用“更新歌单”加载</div>'}function renderLyrics(e){lyricsDisplay.innerHTML="",lyricsPlaceholder.style.display="none",e.forEach(e=>{e.element&&lyricsDisplay.appendChild(e.element)}),state.currentLyrics=e}function updateTimeDisplay(){if(!state.isDragging&&isFinite(audioPlayer.duration)&&audioPlayer.duration>0){const e=audioPlayer.currentTime/audioPlayer.duration*100;progressSlider.value=e,progressSlider.style.setProperty("--progress",e+"%"),currentTime.textContent=formatTime(audioPlayer.currentTime)}else state.isDragging||(currentTime.textContent=formatTime(audioPlayer.currentTime));highlightLyricsAtTime(audioPlayer.currentTime)}function updateProgressPercent(e){progressSlider.style.setProperty("--progress",e+"%")}function updateVolumePercent(e){volumeSlider.style.setProperty("--volume",e+"%")}function highlightLyricsAtTime(e){if(!state.currentLyrics||0===state.currentLyrics.length)return;let t=-1;for(let a=0;a<state.currentLyrics.length;a++){const l=state.currentLyrics[a];if(null!==l.time&&l.time<=e&&(a===state.currentLyrics.length-1||e<state.currentLyrics[a+1].time)){t=a;break}}if(state.currentLyrics.forEach((e,a)=>{e.element&&(e.element.classList.toggle("lyrics-line-current",a===t),e.element.classList.toggle("lyrics-line-faded",a!==t&&Math.abs(a-t)>2))}),t>=0&&state.currentLyrics[t].element){const e=lyricsDisplay,a=state.currentLyrics[t].element;requestAnimationFrame(()=>{const t=e.getBoundingClientRect(),l=a.getBoundingClientRect(),r=t.height,n=l.top-t.top+e.scrollTop-(r-l.height)/2;e.scrollTo({top:n,behavior:"smooth"})})}}function resetPlayerUI(){trackTitle.textContent="暂无歌曲",trackArtist.textContent="——",albumCover.style.backgroundImage="",albumCover.textContent="暂无图片",lyricsDisplay.innerHTML="",lyricsPlaceholder.textContent="暂无歌词",lyricsPlaceholder.style.display="block",currentTime.textContent="00:00",durationTime.textContent="00:00",progressSlider.value=0,audioPlayer.src="",playBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393"/></svg>',state.isPlaying=!1,state.currentLyrics=[]}function parseLyrics(e){const t=e.split(/\r?\n/),a=[],l=/\[(\d{1,2}):(\d{2})(?:[.:](\d{1,3}))?\]/g;for(const e of t){let t=e.trim();if(!t)continue;let r,n=[];for(;null!==(r=l.exec(t));){const e=60*parseInt(r[1],10)+parseInt(r[2],10)+(r[3]?parseInt((r[3]+"00").slice(0,3),10):0)/1e3;n.push(e)}const i=t.replace(l,"").trim();if(n.length>0)for(const e of n){const t=document.createElement("div");t.className="lyrics-line",t.textContent=i||"　",a.push({time:e,text:i||"　",element:t})}else{const e=document.createElement("div");e.className="lyrics-line no-timestamp",e.textContent=t,a.push({time:null,text:t,element:e})}}return a.sort((e,t)=>null===e.time?1:null===t.time?-1:e.time-t.time),a}function formatTime(e){return!isFinite(e)||e<=0?"00:00":(e=Math.max(0,Math.floor(e)),`${String(Math.floor(e/60)).padStart(2,"0")}:${String(e%60).padStart(2,"0")}`)}function formatDuration(e){if(!e)return"";const t=Math.round(Number(e)||0);return`${String(Math.floor(t/60)).padStart(2,"0")}:${String(t%60).padStart(2,"0")}`}function isUrl(e){return"string"==typeof e&&/^https?:\/\//i.test(e)}function escapeHtml(e){return String(e||"").replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))}function showNotice(e,t=3e3){const a=document.getElementById("playerNotice");a.textContent=e,a.style.display="block",a.timeout&&clearTimeout(a.timeout),a.timeout=setTimeout(()=>{a.style.display="none"},t)}audioPlayer.addEventListener("timeupdate",updateTimeDisplay),audioPlayer.addEventListener("durationchange",()=>{durationTime.textContent=formatTime(audioPlayer.duration)}),audioPlayer.addEventListener("play",()=>{state.isPlaying=!0,playBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pause" viewBox="0 0 16 16"><path d="M6 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5m4 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5"/></svg>'}),audioPlayer.addEventListener("pause",()=>{state.isPlaying=!1,playBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393"/></svg>'}),audioPlayer.addEventListener("ended",handleTrackEnded),audioPlayer.addEventListener("error",e=>{console.warn("音频播放错误：",e),showNotice("音频播放失败，请尝试下一首"),state.isBusy=!1}),progressSlider.addEventListener("input",function(){updateProgressPercent(this.value)}),volumeSlider.addEventListener("input",function(){updateVolumePercent(100*this.value)}),updateProgressPercent(progressSlider.value),updateVolumePercent(100*volumeSlider.value);